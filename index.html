<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Seat Booking - Premium Edition</title>
    <!-- Premium Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #050a14;
            --glass-bg: rgba(20, 25, 40, 0.7);
            --glass-border: rgba(255,255, 255, 0.08);
            --text-main: #ffffff;
            --text-muted: #a0aab5;

            /* Neon Status Colors */
            --neon-green: #00ffa3;
            --neon-red: #ff4d4d;
            --neon-blue: #4dabf7;
            --neon-purple: #9b59b6;
            --neon-orange: #ff9500;
            --neon-gold: #ffd700;

            --shadow-glow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            background: radial-gradient(circle at top right, #1c2e4a, #050a14 60%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            overflow-x: hidden; position: relative;
        }

        /* PREMIUM TOP NAV BAR */
        .top-nav {
            position: fixed; top: 0; left: 0; width: 100%;
            height: 80px;
            background: rgba(5, 10, 20, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 40px; z-index: 1000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .logo {
            font-family: 'Outfit', sans-serif; font-size: 1.8rem; font-weight: 700;
            color: #fff; display: flex; align-items: center; letter-spacing: 1px;
        }
        .logo i { color: var(--neon-blue); margin-right: 12px; text-shadow: 0 0 10px var(--neon-blue); }

        .mode-switcher { display: flex; gap: 15px; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 50px; border: 1px solid var(--glass-border); }
        
        .mode-btn {
            padding: 10px 25px; border: none; border-radius: 40px; font-weight: 600;
            font-size: 0.9rem; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-family: 'Outfit', sans-serif; display: flex; align-items: center; gap: 8px;
            background: transparent; color: var(--text-muted);
        }
        .mode-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }
        
        .mode-btn.active { 
            color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            transform: translateY(-1px);
        }
        .mode-student.active { background: linear-gradient(135deg, var(--neon-green), #00d986); color: #000; }
        .mode-admin.active { background: linear-gradient(135deg, var(--neon-purple), #8e44ad); color: #fff; }

        /* STATS HEADER */
        header {
            position: sticky; top: 80px;
            width: 100%; background: rgba(5, 10, 20, 0.9);
            backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2.5rem; display: flex; justify-content: center; align-items: center;
            margin-bottom: 1rem; z-index: 900; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .stats-bar { display: flex; gap: 40px; font-weight: 600; color: var(--text-muted); }
        .stat { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 8px 20px; border-radius: 30px; border: 1px solid var(--glass-border); }
        .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 10px currentColor; }

        /* LOGIN MODAL */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; opacity: 0; pointer-events: none; transition: all 0.3s;
        }
        .login-overlay.active { opacity: 1; pointer-events: auto; }
        
        .login-box {
            background: linear-gradient(145deg, #1e2538, #111622);
            border: 1px solid var(--neon-purple); box-shadow: 0 0 30px rgba(155, 89, 182, 0.2);
            padding: 3rem; border-radius: 24px;
            width: 90%; max-width: 400px; text-align: center;
            position: relative; overflow: hidden;
        }
        .login-box::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(155,89,182,0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite; pointer-events: none;
        }
        @keyframes rotate { 0% {transform: rotate(0deg);} 100% {transform: rotate(360deg);} }
        
        .login-box h2 { color: var(--neon-purple); font-family: 'Outfit'; margin-bottom: 2rem; position: relative; }
        .login-box input {
            width: 100%; padding: 15px; margin-bottom: 1.5rem; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.4); color: #fff;
            font-size: 1.1rem; text-align: center; letter-spacing: 2px;
        }
        .login-box input:focus { border-color: var(--neon-purple); outline: none; box-shadow: 0 0 15px rgba(155,89,182,0.3); }
        
        .login-btn {
            width: 100%; padding: 15px; background: linear-gradient(135deg, var(--neon-purple), #8e44ad);
            color: #fff; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;
            transition: 0.3s; box-shadow: 0 5px 20px rgba(155, 89, 182, 0.4); letter-spacing: 1px;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(155,89,182,0.6); }
        .close-login { margin-top: 1.5rem; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; transition: 0.3s; }
        .close-login:hover { color: #fff; }

        /* LAVISH ADMIN PANEL - SPACING FIXED */
        .admin-controls {
            display: none; 
            background: linear-gradient(135deg, rgba(20, 25, 40, 0.9), rgba(10, 15, 25, 0.9));
            border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 24px;
            padding: 1.5rem 2rem; 
            /* FIXED SPACING: Increased margin-top to 4rem for clear separation */
            margin: 4rem auto 3rem; 
            width: 90%; max-width: 900px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(255,255,255,0.05);
            backdrop-filter: blur(20px); position: relative; overflow: hidden;
        }
        .admin-controls.active { display: block; animation: slideDown 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); }
        
        .admin-controls::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-orange), transparent);
        }

        .control-row { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; align-items: center; position: relative; z-index: 1; }
        
        /* Lavish Button Styles */
        .admin-btn {
            padding: 12px 24px; border-radius: 12px; cursor: pointer;
            font-weight: 700; font-family: 'Outfit'; font-size: 0.95rem;
            transition: all 0.4s ease; display: flex; align-items: center; gap: 10px;
            position: relative; overflow: hidden;
            text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-add { 
            background: linear-gradient(135deg, #00b09b, #96c93d); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(0, 176, 155, 0.4);
        }
        .btn-add:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 176, 155, 0.6); }
        
        .btn-remove { 
            background: linear-gradient(135deg, #ff416c, #ff4b2b); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);
        }
        .btn-remove:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(255, 65, 108, 0.6); }
        
        .btn-move { 
            background: linear-gradient(135deg, #4facfe, #00f2fe); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        .btn-move:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6); }
        
        .btn-logout { 
            background: linear-gradient(135deg, #614385, #516395); color: #fff; border: 1px solid rgba(255,255,255,0.2);
            margin-left: auto; 
        }
        .btn-logout:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(97, 67, 133, 0.6); }

        .admin-input { 
            padding: 12px 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(0,0,0,0.3); color: #fff; width: 100px; text-align: center;
            font-family: 'Outfit'; font-weight: 600; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }
        .admin-input:focus { border-color: var(--neon-orange); outline: none; }


        /* LIBRARY MAP & TABLES */
        .library-map {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
            gap: 3rem; padding: 2rem; width: 100%; max-width: 1400px; perspective: 1200px;
            margin-bottom: 4rem;
        }

        .table-group {
            background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border);
            border-radius: 30px; padding: 25px; position: relative;
            transition: all 0.3s; transform-style: preserve-3d;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; align-items: center;
        }
        
        .table-group.dragging {
            opacity: 0.4; border: 2px dashed var(--neon-blue);
            transform: scale(0.95) rotate(2deg);
        }
        .table-group.drag-over {
            border: 2px dashed var(--neon-green);
            background: rgba(0, 255, 163, 0.05);
        }

        .table-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .table-id { font-size: 1.4rem; font-weight: 700; color: #fff; font-family: 'Outfit'; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,255,255,0.2); }
        .drag-handle { cursor: grab; color: var(--text-muted); padding: 10px; transition: 0.3s; }
        .drag-handle:hover { color: var(--neon-blue); transform: scale(1.2); }

        /* SEAT ROWS */
        .seats-row {
            display: flex; gap: 15px; justify-content: center; width: 100%; margin-bottom: 15px;
        }
        .seats-row:last-child { margin-bottom: 0; margin-top: 15px; }

        .table-surface {
            width: 90%; height: 60px;
            background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5);
            position: relative; z-index: 1;
        }
        .table-surface i { font-size: 1.5rem; color: rgba(255,255,255,0.1); }

        /* SEATS */
        .seat {
            width: 50px; height: 50px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.9rem; color: var(--text-muted);
            cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; backdrop-filter: blur(5px);
        }
        .seat:hover { transform: scale(1.15); z-index: 2; }

        .seat.available { border-color: rgba(0, 255, 163, 0.3); color: var(--neon-green); box-shadow: 0 0 10px rgba(0, 255, 163, 0.1); }
        .seat.available:hover { background: var(--neon-green); color: #000; box-shadow: 0 0 25px var(--neon-green); }

        .seat.occupied { border-color: rgba(255, 77, 77, 0.4); color: var(--neon-red); }
        .seat.occupied::after {
            content: '\f023'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
            position: absolute; font-size: 10px; bottom: 4px; right: 4px;
            color: var(--neon-red);
        }
        .seat.occupied:hover { background: var(--neon-red); color: #fff; box-shadow: 0 0 25px var(--neon-red); }

        /* ACTION MODAL */
        .action-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            display: flex; justify-content: center; align-items: center;
            z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .action-modal.active { opacity: 1; pointer-events: auto; }
        .modal-content {
            background: #1e2538; border: 1px solid rgba(255,255,255,0.1);
            padding: 2.5rem; border-radius: 24px; width: 90%; max-width: 380px; text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            border-top: 4px solid var(--neon-blue);
            transform: scale(0.9); transition: 0.3s;
        }
        .action-modal.active .modal-content { transform: scale(1); }
        
        .modal-content h3 { color: #fff; margin-bottom: 15px; font-family: 'Outfit'; font-size: 1.5rem; }
        .modal-content p { color: var(--text-muted); margin-bottom: 25px; line-height: 1.5; }
        
        .modal-input { width: 100%; padding: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.3); border: 1px solid #333; color: #fff; border-radius: 10px; font-size: 1rem; }
        .modal-input:focus { border-color: var(--neon-blue); outline: none; }
        
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .btn-modal { padding: 12px 25px; border-radius: 10px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; font-family: 'Outfit'; }
        .btn-confirm { background: var(--neon-green); color: #000; }
        .btn-confirm:hover { box-shadow: 0 0 20px rgba(0,255,163,0.4); }
        .btn-danger { background: var(--neon-red); color: #fff; }
        .btn-danger:hover { box-shadow: 0 0 20px rgba(255,77,77,0.4); }
        .btn-cancel { background: transparent; border: 1px solid #333; color: #fff; }
        .btn-cancel:hover { background: #333; }

        /* TOAST */
        .toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: rgba(20, 25, 40, 0.95); border-left: 4px solid var(--neon-blue);
            color: #fff; padding: 15px 30px; border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); transition: 0.4s; z-index: 5000;
            font-weight: 500; display: flex; align-items: center; gap: 12px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @keyframes slideDown { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- 1. UNIFIED TOP NAV -->
    <nav class="top-nav">
        <div class="logo">
            <i class="fas fa-book-reader"></i> Smart<span style="color:var(--neon-blue)">Library</span>
        </div>
        <div class="mode-switcher">
            <button class="mode-btn mode-student active" id="btn-student">
                <i class="fas fa-user-graduate"></i> Student
            </button>
            <button class="mode-btn mode-admin" id="btn-admin">
                <i class="fas fa-user-shield"></i> Librarian
            </button>
        </div>
    </nav>

    <!-- LOGIN MODAL -->
    <div class="login-overlay" id="login-modal">
        <div class="login-box">
            <h2><i class="fas fa-fingerprint"></i> Admin Access</h2>
            <input type="password" id="password-input" placeholder="Enter Password">
            <button class="login-btn" id="btn-login-submit">Unlock Panel</button>
            <button class="close-login" id="btn-login-cancel">Return to Student View</button>
        </div>
    </div>

    <!-- STATS HEADER -->
    <header>
        <div class="stats-bar">
            <div class="stat"><span class="dot" style="background:var(--neon-green)"></span> Available: <span id="avail-count">0</span></div>
            <div class="stat"><span class="dot" style="background:var(--neon-red)"></span> Occupied: <span id="occupied-count">0</span></div>
        </div>
    </header>

    <!-- 3. LAVISH ADMIN CONTROLS (Fixed Spacing) -->
    <div class="admin-controls" id="admin-panel">
        <div style="text-align: center; margin-bottom: 20px; color: var(--neon-orange); font-family: 'Outfit'; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; font-size: 0.9rem;">
            Control Center
        </div>
        <div class="control-row">
            <div class="control-group">
                <input type="number" id="new-table-seats" class="admin-input" value="4" min="1" max="12">
            </div>
            <button class="admin-btn btn-add" id="btn-add-table"><i class="fas fa-plus-circle"></i> Add Table</button>
            
            <button class="admin-btn btn-remove" id="btn-remove-table"><i class="fas fa-trash-alt"></i> Remove Last</button>
            
            <div style="width: 1px; background: rgba(255,255,255,0.1); height: 40px; margin: 0 15px;"></div>
            
            <button class="admin-btn btn-move" id="btn-toggle-drag">
                <i class="fas fa-arrows-up-down-left-right"></i> Arrange Mode
            </button>
            
            <button class="admin-btn btn-logout" id="btn-logout">
                <i class="fas fa-power-off"></i> Logout
            </button>
        </div>
    </div>

    <!-- MAIN MAP -->
    <main class="library-map" id="library-map">
        <!-- Tables generated by JS -->
    </main>

    <!-- MODAL FOR ACTIONS -->
    <div class="action-modal" id="action-modal">
        <div class="modal-content">
            <h3 id="modal-title">Seat Action</h3>
            <p id="modal-desc">Enter details below.</p>
            
            <input type="text" id="occupant-name" class="modal-input" placeholder="Student Name / ID" style="display:none;">
            
            <div class="modal-actions">
                <button class="btn-modal btn-cancel" id="modal-cancel">Cancel</button>
                <button class="btn-modal btn-confirm" id="modal-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div class="toast" id="toast-msg">
        <i class="fas fa-info-circle"></i> <span>Notification</span>
    </div>

    <script>
        // CONFIGURATION
        const ADMIN_PASS = "admin123";
        let isAdmin = false;
        let isDragMode = false;
        let tables = []; 
        let activeSeat = null;

        // DOM ELEMENTS
        const dom = {
            body: document.body,
            map: document.getElementById('library-map'),
            modal: document.getElementById('action-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalDesc: document.getElementById('modal-desc'),
            modalInput: document.getElementById('occupant-name'),
            btnConfirm: document.getElementById('modal-confirm'),
            btnCancel: document.getElementById('modal-cancel'),
            btnStudent: document.getElementById('btn-student'),
            btnAdmin: document.getElementById('btn-admin'),
            loginModal: document.getElementById('login-modal'),
            passInput: document.getElementById('password-input'),
            btnLogin: document.getElementById('btn-login-submit'),
            btnLoginCancel: document.getElementById('btn-login-cancel'),
            adminPanel: document.getElementById('admin-panel'),
            btnAddTable: document.getElementById('btn-add-table'),
            btnRemoveTable: document.getElementById('btn-remove-table'),
            btnDragToggle: document.getElementById('btn-toggle-drag'),
            btnLogout: document.getElementById('btn-logout'),
            availCount: document.getElementById('avail-count'),
            occupiedCount: document.getElementById('occupied-count'),
            toast: document.getElementById('toast-msg')
        };

        function init() {
            loadData();
            renderLibrary();
            updateStats();
            setupEventListeners();
        }

        function setupEventListeners() {
            dom.btnStudent.addEventListener('click', () => switchMode('student'));
            dom.btnAdmin.addEventListener('click', () => switchMode('admin'));

            dom.btnLogin.addEventListener('click', attemptLogin);
            dom.loginModal.addEventListener('click', (e) => {
                if(e.target === dom.loginModal) switchMode('student');
            });
            dom.btnLoginCancel.addEventListener('click', () => switchMode('student'));

            dom.btnAddTable.addEventListener('click', addTable);
            dom.btnRemoveTable.addEventListener('click', removeTable);
            dom.btnDragToggle.addEventListener('click', toggleDragMode);
            dom.btnLogout.addEventListener('click', logout);

            dom.btnCancel.addEventListener('click', closeModal);
            dom.btnConfirm.addEventListener('click', confirmAction);
        }

        // --- AUTHENTICATION ---
        function switchMode(mode) {
            if (mode === 'admin') {
                if (isAdmin) {
                    enableAdminView();
                } else {
                    dom.loginModal.classList.add('active');
                    dom.passInput.value = '';
                    dom.passInput.focus();
                }
            } else {
                enableStudentView();
            }
        }

        function attemptLogin() {
            const pass = dom.passInput.value;
            if (pass === ADMIN_PASS) {
                isAdmin = true;
                dom.loginModal.classList.remove('active');
                enableAdminView();
                showToast("Welcome Librarian! Access Granted.", "success");
            } else {
                showToast("Access Denied. Incorrect Password.", "error");
                dom.passInput.value = '';
                dom.passInput.classList.add('shake');
                setTimeout(() => dom.passInput.classList.remove('shake'), 500);
            }
        }

        function logout() {
            isAdmin = false;
            switchMode('student');
            showToast("Logged out securely.", "info");
        }

        function enableAdminView() {
            dom.body.classList.remove('student-mode');
            dom.body.classList.add('admin-mode');
            dom.btnAdmin.classList.add('active');
            dom.btnStudent.classList.remove('active');
            dom.adminPanel.classList.add('active');
            renderLibrary();
        }

        function enableStudentView() {
            dom.body.classList.remove('admin-mode');
            dom.body.classList.add('student-mode');
            dom.btnStudent.classList.add('active');
            dom.btnAdmin.classList.remove('active');
            dom.adminPanel.classList.remove('active');
            if(isDragMode) toggleDragMode();
            renderLibrary();
        }

        // --- DATA LOGIC ---
        function loadData() {
            const stored = localStorage.getItem('libraryData_v3');
            if (stored) {
                tables = JSON.parse(stored);
            } else {
                // Default: 3 Tables, 4 Seats each
                for(let i=1; i<=3; i++) {
                    tables.push({ id: i, seats: createSeatsArray(4) });
                }
                saveData();
            }
        }

        function createSeatsArray(count) {
            let arr = [];
            for(let j=1; j<=count; j++) {
                arr.push({ id: j, status: 'available', occupant: '' });
            }
            return arr;
        }

        function saveData() {
            localStorage.setItem('libraryData_v3', JSON.stringify(tables));
            updateStats();
        }

        function updateStats() {
            let avail = 0;
            let occ = 0;
            tables.forEach(t => {
                t.seats.forEach(s => {
                    if(s.status === 'available') avail++;
                    else occ++;
                });
            });
            dom.availCount.textContent = avail;
            dom.occupiedCount.textContent = occ;
        }

        // RENDER LOGIC
        function renderLibrary() {
            dom.map.innerHTML = '';
            
            tables.forEach((table, index) => {
                const el = document.createElement('div');
                el.className = 'table-group';
                el.setAttribute('draggable', isDragMode);
                el.dataset.index = index;

                if(isAdmin && isDragMode) {
                    el.addEventListener('dragstart', handleDragStart);
                    el.addEventListener('dragover', handleDragOver);
                    el.addEventListener('drop', handleDrop);
                    el.addEventListener('dragenter', handleDragEnter);
                    el.addEventListener('dragleave', handleDragLeave);
                }

                // Split seats into Top and Bottom
                const midPoint = Math.ceil(table.seats.length / 2);
                const topSeats = table.seats.slice(0, midPoint);
                const bottomSeats = table.seats.slice(midPoint);

                const generateSeatsHTML = (seatArr) => {
                    return seatArr.map(seat => {
                        const isOcc = seat.status === 'occupied';
                        return `
                            <div class="seat ${seat.status}" 
                                 onclick="handleSeatClick(${index}, ${seat.id})">
                                 ${isOcc ? '<i class="fas fa-user"></i>' : seat.id}
                            </div>
                        `;
                    }).join('');
                };

                el.innerHTML = `
                    <div class="table-header">
                        <span class="table-id">Table ${table.id}</span>
                        ${isAdmin && isDragMode ? '<i class="fas fa-grip-lines drag-handle"></i>' : ''}
                    </div>
                    
                    <div class="seats-row">
                        ${generateSeatsHTML(topSeats)}
                    </div>

                    <div class="table-surface">
                        <i class="fas fa-chair"></i>
                    </div>

                    <div class="seats-row">
                        ${generateSeatsHTML(bottomSeats)}
                    </div>
                `;
                dom.map.appendChild(el);
            });
        }

        // --- ADMIN ACTIONS ---
        function addTable() {
            const count = parseInt(document.getElementById('new-table-seats').value) || 4;
            const newId = tables.length > 0 ? Math.max(...tables.map(t => t.id)) + 1 : 1;
            tables.push({ id: newId, seats: createSeatsArray(count) });
            saveData();
            renderLibrary();
            showToast(`Table ${newId} created.`, "success");
        }

        function removeTable() {
            if(tables.length === 0) return showToast("No tables remaining.", "error");
            const removed = tables.pop();
            saveData();
            renderLibrary();
            showToast(`Table ${removed.id} removed.`, "info");
        }

        function toggleDragMode() {
            isDragMode = !isDragMode;
            
            if(isDragMode) {
                dom.btnDragToggle.style.background = 'var(--neon-red)';
                dom.btnDragToggle.innerHTML = '<i class="fas fa-stop"></i> Stop Arranging';
                showToast("Arrange Mode Active: Drag tables to reorder.", "info");
            } else {
                dom.btnDragToggle.style.background = '';
                dom.btnDragToggle.innerHTML = '<i class="fas fa-arrows-up-down-left-right"></i> Arrange Mode';
            }
            renderLibrary();
        }

        // Drag Drop
        let dragSrcIndex = null;
        function handleDragStart(e) {
            dragSrcIndex = +this.dataset.index;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
        function handleDragOver(e) { if (e.preventDefault) e.preventDefault(); return false; }
        function handleDragEnter(e) { this.classList.add('drag-over'); }
        function handleDragLeave(e) { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const dragDestIndex = +this.dataset.index;
            if (dragSrcIndex !== dragDestIndex) {
                const temp = tables[dragSrcIndex];
                tables[dragSrcIndex] = tables[dragDestIndex];
                tables[dragDestIndex] = temp;
                saveData();
                renderLibrary();
                showToast("Tables reordered.", "success");
            }
            return false;
        }

        // --- SEAT ACTIONS ---
        window.handleSeatClick = function(tableIndex, seatId) {
            const table = tables[tableIndex];
            const seat = table.seats.find(s => s.id === seatId);
            activeSeat = { tableIndex, seatId, seatObj: seat };

            if (isAdmin) {
                if (seat.status === 'available') {
                    openModal('book');
                } else {
                    openModal('vacate');
                }
            } else {
                if (seat.status === 'available') {
                    showToast("Please contact the librarian to book.", "info");
                } else {
                    showToast(`Occupied by: ${seat.occupant}`, "info");
                }
            }
        };

        function openModal(action) {
            dom.modal.classList.add('active');
            dom.modalInput.value = ''; 

            if (action === 'book') {
                dom.modalTitle.textContent = "Reserve Seat";
                dom.modalTitle.style.color = "var(--neon-green)";
                dom.modalDesc.textContent = "Enter student details for this seat.";
                dom.modalInput.style.display = "block";
                dom.modalInput.focus();
                dom.btnConfirm.className = "btn-modal btn-confirm";
                dom.btnConfirm.textContent = "Confirm Booking";
            } else {
                dom.modalTitle.textContent = "Release Seat";
                dom.modalTitle.style.color = "var(--neon-red)";
                dom.modalDesc.textContent = `Release this seat for: ${activeSeat.seatObj.occupant}?`;
                dom.modalInput.style.display = "none";
                dom.btnConfirm.className = "btn-modal btn-danger";
                dom.btnConfirm.textContent = "Yes, Release";
            }
        }

        function closeModal() {
            dom.modal.classList.remove('active');
            activeSeat = null;
        }

        function confirmAction() {
            if (!activeSeat) return;

            if (dom.modalInput.style.display !== 'none') {
                const name = dom.modalInput.value.trim();
                if (!name) return showToast("Name is required.", "error");
                activeSeat.seatObj.status = 'occupied';
                activeSeat.seatObj.occupant = name;
                showToast(`Seat reserved for ${name}`, "success");
            } else {
                activeSeat.seatObj.status = 'available';
                activeSeat.seatObj.occupant = '';
                showToast("Seat released.", "success");
            }
            saveData();
            renderLibrary();
            closeModal();
        }

        // Utils
        function showToast(msg, type) {
            const toast = dom.toast;
            toast.querySelector('span').textContent = msg;
            
            if(type === 'error') toast.style.borderLeftColor = 'var(--neon-red)';
            else if(type === 'success') toast.style.borderLeftColor = 'var(--neon-green)';
            else toast.style.borderLeftColor = 'var(--neon-blue)';

            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        init();
    </script>
</body>
</html>